import pytest

from shapely import Polygon, from_wkt
from pygeomatch import radial

@pytest.fixture()
def square():
    return Polygon([(0, 0), (10, 0), (10, 10), (0, 10), (0, 0)])

@pytest.fixture()
def house():
    return Polygon([(0, 0), (10, 0), (10, 10), (5, 11), (0, 10), (0, 0)])

@pytest.fixture()
def polygon1():
    return from_wkt("POLYGON ((662755 6854290.20000000018626451 40.20000000000000284,662758.09999999997671694 6854296.29999999981373549 40.20000000000000284,662760 6854295.29999999981373549 40.20000000000000284, 662760.59999999997671694 6854296.29999999981373549 40.20000000000000284, 662761.5 6854295.90000000037252903 40.20000000000000284, 662760.90000000002328306 6854294.90000000037252903 40.20000000000000284, 662762 6854294.29999999981373549 40.20000000000000284, 662762.59999999997671694 6854295.40000000037252903 40.20000000000000284, 662762.90000000002328306 6854295.29999999981373549 40.20000000000000284, 662767.80000000004656613 6854304.40000000037252903 40.20000000000000284, 662769.59999999997671694 6854303.5 40.20000000000000284, 662765.80000000004656613 6854296.20000000018626451 40.20000000000000284, 662764.59999999997671694 6854294 40.20000000000000284, 662762.5 6854289.79999999981373549 40.20000000000000284, 662761 6854287 40.20000000000000284, 662755 6854290.20000000018626451 40.20000000000000284))")

@pytest.fixture()
def polygon2():
    return from_wkt("POLYGON ((662761 6854297 0, 662762 6854296 0, 662761 6854295 0, 662763 6854295 0, 662763 6854296 0, 662763 6854296 0, 662768 6854305 0, 662770 6854304 0, 662766 6854297 0, 662765 6854295 0, 662763 6854290 0, 662761 6854288 0, 662755 6854291 0,662759 6854297 0, 662760 6854296 0, 662761 6854297 0))")

@pytest.fixture()
def polygon_osm():
    return from_wkt("POLYGON Z ((657978.438052 6854763.133397 0,657988.213511 6854763.72974 0,657988.016474 6854766.955721 0,657980.813847 6854766.563124 0,657980.161364 6854777.909383 0,658004.342021 6854779.290956 0,658004.990525 6854767.38877 0,658003.520454 6854767.288222 0,658004.10596 6854756.831983 0,658005.649497 6854756.932 0,658006.364227 6854744.028614 0,658004.967614 6854743.927533 0,658005.359296 6854737.142018 0,657999.18593 6854736.853138 0,657999.188345 6854737.186695 0,657996.248187 6854736.985601 0,657996.245772 6854736.652044 0,657990.0716 6854736.251988 0,657989.875365 6854739.589153 0,657983.848123 6854739.18804 0,657983.653502 6854742.747577 0,657982.256888 6854742.646501 0,657981.40817 6854757.329925 0,657978.835339 6854757.126179 0,657978.438052 6854763.133397 0))")

@pytest.fixture()
def polygon_bdtopo():
    return from_wkt("POLYGON Z ((658004.7 6854776.2 52,658005.2 6854767.6 52,658001.1 6854767.5 52,658001.8 6854755.1 52,658005.9 6854755.5 52,658006.4 6854744.0 52.1,658005.1 6854743.9 52.2,658005.3 6854737.2 51.4,657990.2 6854736.6 51.4,657989.7 6854743.1 51.4,657988.6 6854743.1 51.4,657988.1 6854754.6 51.4,657989.4 6854754.7 51.4,657989.1 6854756.6 51.4,657978.5 6854756.3 43.4,657978.0 6854763.6 43.4,657988.5 6854762.8 51.7,657988.3 6854766.4 51.7,657987.2 6854766.3 51.7,657986.9 6854774.9 51.7,658004.7 6854776.2 52))")

def test_interpolate():
    coordinate_list = [[0., 0.],[100., 10.]]
    fs = 10
    t = [s/fs for s in range(1, fs+1)]
    interpolated = [radial.interpolate(coordinate_list[0], coordinate_list[1], s) for s in t]
    expected = [[10.0, 1.0], [20.0, 2.0], [30.0, 3.0], [40.0, 4.0], [50.0, 5.0], [60.0, 6.0], [70.0, 7.0], [80.0, 8.0], [90.0, 9.0], [100.0, 10.0]]
    assert interpolated == expected

def test_signature(polygon1, polygon_bdtopo):
    signature = radial.signature(polygon1, fs=1)
    print(polygon1)
    print(signature)
    # expected1 = [0.0, 0.07692307692307693, 0.15384615384615385, 0.23076923076923075, 0.3076923076923077, 0.38461538461538464, 0.4615384615384615, 0.5384615384615384, 0.6153846153846154, 0.6923076923076923, 0.7692307692307693, 0.8461538461538463, 0.923076923076923, 1.0]
    # expected2 = [4.2527833871482015, 2.198043488642399, 0.9174335632591638, 1.5854731701083395, 1.6232791958325663, 1.661085221556793, 11.974894037472875, 12.105173762589905, 12.235453487706934, 4.38869556728175, 3.099158907785908, 4.231488851402946, 5.693535750888817, 7.137023069522707]
    expected1 = [0.06666666666666667, 0.13333333333333333, 0.20000000000000004, 0.2666666666666667, 0.33333333333333337, 0.4000000000000001, 0.4666666666666667, 0.5333333333333333, 0.6000000000000001, 0.6666666666666667, 0.7333333333333334, 0.7999999999999999, 0.8666666666666667, 0.9333333333333333, 1.0]
    expected2 = [7.78526263707617, 7.4417127188564764, 2.2694836877531266, 0.8003695190631012, 1.5871877719443677, 1.6248223374849915, 1.6624569030256156, 11.979030005116199, 12.108718877712754, 12.238407750309307, 4.365302027425162, 3.081613752893468, 4.246685487653347, 5.700082342230809, 7.137023069522707]
    assert signature[0] == expected1
    assert signature[1] == expected2
    # print("signature bdtopo")
    # signature = radial.signature(polygon_bdtopo, fs=10, nb=100)
    # print(signature[0])
    # print(signature[1])
    # assert False

def test_signature_square(square):
    signature = radial.signature(square, fs=10, nb=20)
    print(signature)
    # expected_s = [0.025, 0.07631578947368421, 0.12763157894736843, 0.17894736842105266, 0.23026315789473686, 0.28157894736842104, 0.3328947368421053, 0.3842105263157895, 0.4355263157894737, 0.48684210526315796, 0.5381578947368422, 0.5894736842105264, 0.6407894736842106, 0.6921052631578948, 0.743421052631579, 0.7947368421052632, 0.8460526315789474, 0.8973684210526317, 0.9486842105263159, 1.0]
    # expected_r = [7.0710678118654755, 5.807489416544732, 5.088596406898807, 5.144200349415161, 5.95140923012689, 6.895293187014784, 5.690177025041891, 5.062538640163864, 5.219501742452456, 6.101980899228877, 6.719518562164092, 5.572864633539049, 5.03648087342892, 5.294803135489751, 6.252552568330864, 6.543743937313401, 5.455552242036207, 5.010423106693977, 5.370104528527047, 6.4031242374328485]
    expected_s = [0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1.0]
    expected_r = [6.4031242374328485, 5.385164807134504, 5.0, 5.385164807134504, 6.4031242374328485, 6.4031242374328485, 5.385164807134504, 5.0, 5.385164807134504, 6.4031242374328485, 6.4031242374328485, 5.385164807134504, 5.0, 5.385164807134504, 6.4031242374328485, 6.4031242374328485, 5.385164807134504, 5.0, 5.385164807134504, 6.4031242374328485]
    assert signature[0] == expected_s
    assert signature[1] == expected_r

def test_signature_house(house):
    signature = radial.signature(house, fs=2, nb=20)
    print(signature)
    # expected_s = [0.12438417696491476, 0.17046922028255082, 0.2165542636001869, 0.26263930691782295, 0.308724350235459, 0.35480939355309504, 0.4008944368707312, 0.44697948018836725, 0.49306452350600327, 0.5391495668236393, 0.5852346101412753, 0.6313196534589115, 0.6774046967765476, 0.7234897400941835, 0.7695747834118197, 0.8156598267294558, 0.8617448700470918, 0.9078299133647277, 0.9539149566823639, 1.0]
    # expected_r = [7.252874079542966, 6.5122681294351, 5.771662179327233, 5.476880278717141, 6.217486228825008, 6.958092178932874, 6.751844103454401, 5.919529691767543, 5.0872152800806845, 6.244771298027898, 6.479498107487726, 5.804135342059997, 5.756732451053992, 5.782733932015504, 5.970915360014616, 6.372008290771339, 6.77310122152806, 6.405014901972569, 5.705730367249621, 5.006445832526673]
    expected_s = [0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.8500000000000001, 0.9000000000000001, 0.95, 1.0]
    expected_r = [7.252874079542966, 7.252874079542966, 6.841217073474052, 6.0376961295928435, 5.273761322224874, 6.077282266106082, 6.880803209987291, 6.767997992965204, 5.864977889511874, 5.079749072493761, 6.5676610981648516, 6.227473323038821, 5.78492081241448, 5.7585724794208, 5.810002279192589, 6.235715790083676, 6.670881846012314, 6.523824323207922, 5.7651350778673, 5.006445832526673]
    assert signature[0] == expected_s
    assert signature[1] == expected_r

def test_correlate_square_house(square,house):
    r1 = radial.signature(square, fs=2, nb=20)
    r2 = radial.signature(square, fs=2, nb=20)
    corr = radial.correlate(r1[1], r2[1])
    assert corr == [1.0, 0.2518248175182483, -0.6423357664233579, -0.6423357664233579, 0.19708029197080304, 0.8175182481751823, 0.19708029197080312, -0.6423357664233579, -0.6423357664233579, 0.1970802919708031, 0.8175182481751823, 0.1970802919708031, -0.6423357664233579, -0.6423357664233579, 0.1970802919708031, 0.8175182481751823, 0.1970802919708031, -0.6423357664233579, -0.6423357664233579, 0.2518248175182483]

def test_radial_distance_square_house(square,house):
    dist = radial.radial_distance(square, house, fs=2, nb=20)
    assert dist == pytest.approx(0.36680223849154703)# tested with R version: 0.3767798
    dist = radial.radial_distance(square, house, fs=2, nb=20, fft=True)
    assert dist == pytest.approx(0.36680223849154703)# tested with R version: 0.3767798

def test_radial_distance(polygon1, polygon2, polygon_osm, polygon_bdtopo):
    dist = radial.radial_distance(polygon1, polygon2, fs=1)#no interpolation
    print(dist)
    assert dist == pytest.approx(0.45895420122901764)#value from tracklib is 0.0915944791404684
    dist = radial.radial_distance(polygon1, polygon2, fs=1, fft=True)#no interpolation
    print(dist)
    assert dist == pytest.approx(0.45895420122901764)#value from tracklib is 0.0915944791404684
    dist = radial.radial_distance(polygon_osm, polygon_bdtopo, fs=10, nb=1000)#no interpolation
    print(dist)
    assert dist == pytest.approx(4.111960128825191)#4.681402
